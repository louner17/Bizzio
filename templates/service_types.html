{% extends "base.html" %}

{% block content %}
<header>
  <h2 class="page-header-title"></h2>
</header>

<div class="content-card">
    <div class="page-header" style="margin-bottom: 0; padding-bottom: 0;">
        <div class="page-header-left">
            <h3>Lista typów usług</h3>
        </div>
        <div class="page-header-right">
            <button class="button primary-button" id="open-modal-btn">
                <i class="ri-add-line"></i> Dodaj typ
            </button>
        </div>
    </div>
    <div class="table-responsive">
      <table class="content-table">
        <thead>
          <tr>
            <th>Nazwa</th>
            <th>Kategoria</th>
            <th>VAT (%)</th>
            <th>Cena bazowa (PLN)</th>
            <th style="width: 150px;">Akcje</th>
          </tr>
        </thead>
        <tbody id="list-tbody-service-types">
          <tr><td colspan="5">Ładowanie…</td></tr>
        </tbody>
      </table>
    </div>
</div>

<div id="service-type-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close-button">&times;</button>
    <h3 id="modal-title">Dodaj nowy typ usługi</h3>
    <form id="service-type-form">
      <label for="type-name">Nazwa</label>
      <input type="text" id="type-name" name="name" required>

      <label for="type-category">Kategoria</label>
      <select id="type-category" name="service_category_id" required>
        <option value="">-- Wybierz kategorię --</option>
        {% for c in categories %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>

      <label for="type-vat">Stawka VAT</label>
      <select id="type-vat" name="vat_rate_id" required>
        <option value="">-- Wybierz stawkę --</option>
        {% for v in vat_rates %}
          <option value="{{ v.id }}">{{ v.description }}</option>
        {% endfor %}
      </select>

      <label for="type-default-price">Cena domyślna (PLN)</label>
      <input type="number" id="type-default-price" name="default_price" step="0.01">
        <label for="type-duration">Czas trwania (minuty)</label>
        <input type="number" id="type-duration" name="duration_minutes" step="15">
      <button type="submit" class="primary-button" id="modal-submit-button">Dodaj typ</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('service-type-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSubmitButton = document.getElementById('modal-submit-button');
        const form = document.getElementById('service-type-form');
        const tbody = document.getElementById('list-tbody-service-types');
        let currentEditId = null;

        async function loadTypes() {
            tbody.innerHTML = '<tr><td colspan="5">Ładowanie…</td></tr>';
            try {
                const res = await fetch('/api/service_types');
                if (!res.ok) throw new Error(await res.text());
                const list = await res.json();
                tbody.innerHTML = list.length ? list.map(t => `
                    <tr>
                        <td>${t.name}</td>
                        <td>${t.category.name}</td>
                        <td>${(t.vat_rate * 100).toFixed(0)}</td>
                        <td>${t.default_price ? t.default_price.toFixed(2) : 'Brak'}</td>
                        <td>
                            <button class="button-small edit-btn" data-id="${t.id}">Edytuj</button>
                            <button class="button-small delete-btn" data-id="${t.id}" data-name="${t.name}">Usuń</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5">Brak typów usług.</td></tr>';
            } catch (e) {
                showToast(`Błąd ładowania: ${e.message}`, 'error');
            }
        }

        function setupModal(isEditing, data = {}) {
            currentEditId = isEditing ? data.id : null;
            form.reset();
            modalTitle.textContent = isEditing ? 'Edytuj typ usługi' : 'Dodaj nowy typ usługi';
            modalSubmitButton.textContent = isEditing ? 'Zapisz zmiany' : 'Dodaj typ';

            if (isEditing) {
                form.elements.name.value = data.name;
                form.elements.service_category_id.value = data.service_category_id;
                form.elements.vat_rate_id.value = data.vat_rate_id;
                form.elements.default_price.value = data.default_price || '';
                form.elements.duration_minutes.value = data.duration_minutes || '';
            }
            modal.classList.add('active');
        }

        document.getElementById('open-modal-btn').addEventListener('click', () => setupModal(false));
        modal.querySelector('.modal-close-button').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', e => (e.target === modal) && modal.classList.remove('active'));

        tbody.addEventListener('click', async e => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('edit-btn')) {
                const res = await fetch('/api/service_types');
                const types = await res.json();
                const typeData = types.find(t => t.id == id);
                if (typeData) setupModal(true, typeData);
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm(`Czy na pewno chcesz usunąć "${target.dataset.name}"?`)) {
                    const res = await fetch(`/api/service_types/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast('Typ usługi usunięty.', 'success');
                        loadTypes();
                    } else {
                        showToast('Błąd usuwania.', 'error');
                    }
                }
            }
        });

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const payload = {
                name: form.elements.name.value,
                service_category_id: parseInt(form.elements.service_category_id.value),
                vat_rate_id: parseInt(form.elements.vat_rate_id.value),
                default_price: parseFloat(form.elements.default_price.value) || null,
                duration_minutes: parseInt(form.elements.duration_minutes.value) || 60
            };

            const isEditing = currentEditId !== null;
            const url = isEditing ? `/api/service_types/${currentEditId}` : '/api/service_types/add';
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Błąd zapisu');
                showToast(isEditing ? 'Zaktualizowano!' : 'Dodano!', 'success');
                modal.classList.remove('active');
                loadTypes();
            } catch (err) {
                showToast(err.message, 'error');
            }
        });

        loadTypes();
    });
</script>
{% endblock %}