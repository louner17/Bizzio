{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <h2 class="page-header-title">Rejestr kosztów</h2>
    </div>
    <div class="page-header-right">
    <button class="button" id="open-export-modal-btn"><i class="ri-mail-send-line"></i> Przekaż do księgowego</button>
    <button class="button primary-button" id="open-modal-btn">
        <i class="ri-add-line"></i> Zarejestruj fakturę
    </button>
    </div>
</div>

<div class="content-card">
    <div class="table-responsive">
        <table class="content-table">
            <thead>
                <tr>
                    <th>Nr faktury</th>
                    <th>Data faktury</th>
                    <th>Kontrahent</th>
                    <th>Kwota brutto</th>
                    <th>Kwota VAT</th>
                    <th>Kwota netto</th>
                    <th>Kategoria</th>
                    <th>Termin pł.</th>
                    <th>Zapłacono</th>
                    <th>U księg.</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody id="list-tbody-costs">
                <tr><td colspan="11">Ładowanie…</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="cost-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close-button">&times;</button>
    <h3 id="modal-title">Zarejestruj nową fakturę</h3>
    <form id="cost-form" enctype="multipart/form-data">
        <label for="invoice_number">Numer faktury</label>
        <input type="text" id="invoice_number" name="invoice_number" required>

        <label for="description">Opis</label>
        <input type="text" id="description" name="description" required>

        <label for="contractor_name">Kontrahent</label>
        <input type="text" id="contractor_name" name="contractor_name" list="contractors-list" required>
        <datalist id="contractors-list">
            {% for c in contractors %}<option value="{{ c.name }}"></option>{% endfor %}
        </datalist>

        <div class="grid">
            <label for="amount_net">Kwota netto
                <input type="number" id="amount_net" name="amount_net" step="0.01" required>
            </label>
            <label for="amount_gross">Kwota brutto
                <input type="number" id="amount_gross" name="amount_gross" step="0.01" required>
            </label>
        </div>

        <label for="category_id">Kategoria</label>
        <select id="category_id" name="category_id" required>
            {% for cat in expense_categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
        </select>

        <div class="grid">
            <label for="invoice_date">Data faktury
                <input type="text" id="invoice_date" name="invoice_date" required>
            </label>
            <label for="due_date">Termin płatności
                <input type="text" id="due_date" name="due_date" required>
            </label>
        </div>
        <label>
            <input type="checkbox" id="is_paid" name="is_paid">
            Oznacz jako opłaconą
        </label>
        <div id="payment_date_wrapper" style="display: none;">
            <label for="payment_date">Data płatności
                <input type="text" id="payment_date" name="payment_date">
            </label>
        </div>
        <label for="attachment">Załącznik (PDF, JPG, PNG)</label>
        <input type="file" id="attachment" name="attachment">

      <button type="submit" class="primary-button" id="modal-submit-button">Dodaj koszt</button>
    </form>
  </div>
</div>

<div id="export-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-button">&times;</button>
        <h3>Wybierz okres do eksportu</h3>
        <form id="export-form">
            <div class="grid">
                <label>Miesiąc
                    <select id="export-month" name="month"></select>
                </label>
                <label>Rok
                    <input type="number" id="export-year" name="year" placeholder="Rok">
                </label>
            </div>
            <button type="submit" class="primary-button" id="export-generate-btn">
                Generuj paczkę ZIP
                <span class="pico-loading" id="export-loader" style="display: none; margin-left: 0.5rem;"></span>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // === Elementy DOM i zmienne ===
    const modal = document.getElementById('cost-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('cost-form');
    const tbody = document.getElementById('list-tbody-costs');
    const isPaidCheckbox = document.getElementById('is_paid');
    const paymentDateWrapper = document.getElementById('payment_date_wrapper');
    let currentEditId = null;

    // NOWE Elementy DOM dla eksportu
    const exportModal = document.getElementById('export-modal');
    const exportForm = document.getElementById('export-form');
    const openExportModalBtn = document.getElementById('open-export-modal-btn');
    const exportLoader = document.getElementById('export-loader');
    const monthSelect = document.getElementById('export-month');
    const yearInput = document.getElementById('export-year');

    // === Inicjalizacja Flatpickr ===
    const fpInvoice = flatpickr(form.elements.invoice_date, { dateFormat: "Y-m-d", locale: "pl" });
    const fpDue = flatpickr(form.elements.due_date, { dateFormat: "Y-m-d", locale: "pl" });
    const fpPayment = flatpickr(form.elements.payment_date, { dateFormat: "Y-m-d", locale: "pl" });

    // Wypełnij select z miesiącami
    const months = ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"];
    months.forEach((month, index) => {
        monthSelect.options[monthSelect.options.length] = new Option(month, index + 1);
    });

    // --- Funkcje ---
    async function loadCosts() {
        tbody.innerHTML = `<tr><td colspan="11">Ładowanie…</td></tr>`;
        try {
            const res = await fetch('/costs/api');
            if (!res.ok) throw new Error('Błąd pobierania danych');
            const costs = await res.json();
            renderTable(costs);
        } catch (e) {
            showToast(e.message, 'error');
        }
    }

    function renderTable(costs) {
        let currentMonth = null;
        let useAlternateColor = false;
        tbody.innerHTML = costs.length ? costs.map(c => {
            const recordMonth = c.invoice_date.substring(5, 7);
            if (recordMonth !== currentMonth) {
                currentMonth = recordMonth;
                useAlternateColor = !useAlternateColor;
            }
            const rowClasses = [];
            if (!c.is_paid) rowClasses.push('row-unpaid');
            if (useAlternateColor) rowClasses.push('row-alternate');
            return `
                <tr class="${rowClasses.join(' ')}">
                    <td>${c.invoice_number}</td><td>${c.invoice_date}</td>
                    <td>${c.contractor.name}</td><td>${c.amount_gross.toFixed(2)}</td>
                    <td>${c.amount_vat.toFixed(2)}</td><td>${c.amount_net.toFixed(2)}</td>
                    <td>${c.category.name}</td><td>${c.due_date}</td>
                    <td>${c.is_paid ? `<span class="status-paid">${c.payment_date}</span>` : '<span class="status-unpaid">Nie</span>'}</td>
                    <td>${c.is_transferred_to_accountant ? `<span class="status-transferred">Tak</span>` : '<span class="status-not-transferred">Nie</span>'}</td>
                    <td><button class="button-small edit-btn" data-id="${c.id}">Edytuj</button>${!c.is_paid ? `<button class="button-small button-paid" data-id="${c.id}">Zapłacono</button>` : ''}</td>
                </tr>`;
        }).join('') : `<tr><td colspan="11">Brak kosztów.</td></tr>`;
    }

    function setupModal(isEditing, data = {}) {
        currentEditId = isEditing ? data.id : null;
        modalTitle.textContent = isEditing ? 'Edytuj koszt' : 'Zarejestruj fakturę';
        form.elements.invoice_number.value = data.invoice_number || '';
        form.elements.description.value = data.description || '';
        form.elements.contractor_name.value = data.contractor ? data.contractor.name : '';
        form.elements.amount_net.value = data.amount_net || '';
        form.elements.amount_gross.value = data.amount_gross || '';
        form.elements.category_id.value = data.category_id || '';
        fpInvoice.setDate(data.invoice_date || new Date());
        fpDue.setDate(data.due_date || new Date());
        isPaidCheckbox.parentElement.style.display = isEditing ? 'none' : 'block';
        paymentDateWrapper.style.display = 'none';
        isPaidCheckbox.checked = false;
        modal.classList.add('active');
    }

    // === Event Listeners ===
    isPaidCheckbox.addEventListener('change', (e) => {
        paymentDateWrapper.style.display = e.target.checked ? 'block' : 'none';
        if (e.target.checked) { fpPayment.setDate(new Date()); }
    });
    document.getElementById('open-modal-btn').addEventListener('click', () => setupModal(false));
    modal.querySelector('.modal-close-button').addEventListener('click', () => modal.classList.remove('active'));

    tbody.addEventListener('click', async e => { /* ... (logika edycji/płatności bez zmian) ... */ });
    form.addEventListener('submit', async e => { /* ... (logika zapisu kosztu bez zmian) ... */ });

    // === NOWA LOGIKA: Obsługa modala eksportu ===
    openExportModalBtn.addEventListener('click', () => {
        const now = new Date();
        const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        monthSelect.value = prevMonth.getMonth() + 1;
        yearInput.value = prevMonth.getFullYear();
        exportModal.classList.add('active');
    });

    exportModal.querySelector('.modal-close-button').addEventListener('click', () => exportModal.classList.remove('active'));

    exportForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        exportLoader.style.display = 'inline-block';
        e.target.querySelector('button').disabled = true;
        const formData = new FormData();
        formData.append('month', monthSelect.value);
        formData.append('year', yearInput.value);

        try {
            const res = await fetch('/costs/api/export-for-accountant', { method: 'POST', body: formData });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || 'Błąd podczas generowania paczki.');
            }
            const blob = await res.blob();
            const header = res.headers.get('Content-Disposition');
            const parts = header.split(';');
            const filename = parts[1].split('=')[1].replace(/"/g, '');
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Paczka dla księgowego wygenerowana!', 'success');
            exportModal.classList.remove('active');
            loadCosts();
        } catch (err) {
            showToast(err.message, 'error');
        } finally {
            exportLoader.style.display = 'none';
            e.target.querySelector('button').disabled = false;
        }
    });

    // --- Start ---
    loadCosts();
});
</script>
{% endblock %}