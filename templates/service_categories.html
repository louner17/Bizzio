{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h2 class="page-header-title"></h2>
    <div class="page-header-right">
        <button class="button primary-button" id="open-modal-btn">
            <i class="ri-add-line"></i> Dodaj kategorię
        </button>
    </div>
</div>

<div class="content-card">
    <div class="table-responsive">
        <table class="content-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nazwa kategorii</th>
                    <th style="width: 150px;">Akcje</th>
                </tr>
            </thead>
            <tbody id="list-tbody-categories">
                <tr><td colspan="3">Ładowanie…</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="category-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close-button">&times;</button>
    <h3 id="modal-title">Dodaj nową kategorię</h3>
    <form id="category-form">
      <label for="category-name">Nazwa kategorii</label>
      <input type="text" id="category-name" name="name" required>

      <label>Kolor kategorii</label>
      <div class="color-picker" id="color-picker">
          <span class="color-swatch" data-color="#5D5FEF" style="background-color: #5D5FEF;"></span>
          <span class="color-swatch" data-color="#FF7A85" style="background-color: #FF7A85;"></span>
          <span class="color-swatch" data-color="#4FD1C5" style="background-color: #4FD1C5;"></span>
          <span class="color-swatch" data-color="#A0AEC0" style="background-color: #A0AEC0;"></span>
          <span class="color-swatch" data-color="#F6E05E" style="background-color: #F6E05E;"></span>
          <span class="color-swatch" data-color="#FC8181" style="background-color: #FC8181;"></span>
      </div>
      <input type="hidden" id="category-color" name="color">

      <button type="submit" class="primary-button" id="modal-submit-button">Dodaj</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Elementy DOM ---
    const modal = document.getElementById('category-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubmitButton = document.getElementById('modal-submit-button');
    const form = document.getElementById('category-form');
    const tbody = document.getElementById('list-tbody-categories');
    const colorPicker = document.getElementById('color-picker');
    const hiddenColorInput = document.getElementById('category-color');
    let currentEditId = null;

    async function loadCategories() {
        tbody.innerHTML = '<tr><td colspan="3">Ładowanie…</td></tr>';
        try {
            const res = await fetch('/api/service_categories');
            if (!res.ok) throw new Error('Błąd pobierania danych');
            const categories = await res.json();

            tbody.innerHTML = categories.length ? categories.map(cat => `
                <tr>
                    <td>${cat.id}</td>
                    <td>
                        <span class="color-swatch" style="background-color:${cat.color || '#A0AEC0'}; display: inline-block; vertical-align: middle; width: 1em; height: 1em; border-radius: 50%;"></span>
                        <span style="vertical-align: middle; margin-left: 0.5em;">${cat.name}</span>
                    </td>
                    <td>
                        <button class="button-small edit-btn" data-id="${cat.id}">Edytuj</button>
                        <button class="button-small delete-btn" data-id="${cat.id}" data-name="${cat.name}">Usuń</button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="3">Brak kategorii.</td></tr>';
        } catch (e) {
            showToast(e.message, 'error');
        }
    }

    function setupModal(isEditing, data = {}) {
        currentEditId = isEditing ? data.id : null;
        form.reset();
        modalTitle.textContent = isEditing ? 'Edytuj kategorię' : 'Dodaj nową kategorię';
        modalSubmitButton.textContent = isEditing ? 'Zapisz zmiany' : 'Dodaj';

        form.elements.name.value = data.name || '';

        const colorToSelect = data.color || '#5D5FEF';
        hiddenColorInput.value = colorToSelect;
        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('selected', swatch.dataset.color === colorToSelect);
        });

        modal.classList.add('active');
    }

    document.getElementById('open-modal-btn').addEventListener('click', () => setupModal(false));
    modal.querySelector('.modal-close-button').addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', e => (e.target === modal) && modal.classList.remove('active'));

    colorPicker.addEventListener('click', e => {
        if (e.target.classList.contains('color-swatch')) {
            const selectedColor = e.target.dataset.color;
            hiddenColorInput.value = selectedColor;
            colorPicker.querySelector('.selected')?.classList.remove('selected');
            e.target.classList.add('selected');
        }
    });

    tbody.addEventListener('click', async e => {
        const target = e.target;
        const id = target.dataset.id;
        if (!id) return;

        if (target.classList.contains('edit-btn')) {
            const res = await fetch('/api/service_categories');
            const categories = await res.json();
            const categoryData = categories.find(c => c.id == id);
            if (categoryData) setupModal(true, categoryData);
        }

        if (target.classList.contains('delete-btn')) {
            if (confirm(`Czy na pewno chcesz usunąć kategorię "${target.dataset.name}"?`)) {
                // Logika usuwania (działała poprzednio)
                const res = await fetch(`/api/service_categories/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Kategoria usunięta!', 'success');
                    loadCategories();
                } else {
                    showToast('Błąd usuwania.', 'error');
                }
            }
        }
    });

    form.addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
            name: form.elements.name.value,
            color: hiddenColorInput.value
        };

        const isEditing = currentEditId !== null;
        const url = isEditing ? `/api/service_categories/${currentEditId}` : '/api/service_categories/add';
        const method = isEditing ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error((await res.json()).detail || 'Błąd zapisu');
            showToast(isEditing ? 'Zaktualizowano!' : 'Dodano!', 'success');
            modal.classList.remove('active');
            loadCategories();
        } catch (err) {
            showToast(err.message, 'error');
        }
    });

    loadCategories();
});
</script>
{% endblock %}